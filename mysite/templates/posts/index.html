<!-- Created by Naoki Hirabayashi.
Masato Umakoshi: Modify for backend.
design updated and Made a templates extends by Yamamoto Sota
-->

{% extends "base_header.html" %}
{% load static %}

<!doctype html>
<html>

<head>
  {% block head %}
  <link rel="stylesheet" type="text/css" href="{% static 'posts/top.css' %}">
  <title>タイムライン画面</title>
  {% endblock head %}
</head>

<body>
  {% block contents %}
    <div id="content">
      <main>
        <div class="scroll-list">
          {% for post, wokashi_sum, ahare_sum, book, bookmark_flag in zipped_post %}
          <div class="post-box">
            <div class="box-primary">
              <div class="cover-img">
                <img src="{% static 'posts/img/book.png' %}">
              </div>
              <div class="sentence">
                <p>{{ post.content }}</p>
              </div>
            </div>
            <div class="box-secondary">
              <button class="bookmark-btn">しおり</button>
              <div class="wokashi">
                <button onclick="wokashi_create('{% url 'wokashi' post.id %}', 'wokashi_sum{{ post.id }}')">をかし</button>
                <span id="wokashi_sum{{ post.id }}">
                  {% if wokashi_sum is None %}0{% endif %}
                  {% if not wokashi_sum is None %}{{wokashi_sum}}{% endif %}
                </span>
                <!-- <form action="{% url 'wokashi' post.id %}" method="post">
                  <button type="submit" name='post_id' value={{post.id}}>をかし</button>
                  <span>
                  {% if wokashi_sum is None %}0{% endif %}
                  {% if not wokashi_sum is None %}{{wokashi_sum}}{% endif %}
                  </span>
                {% csrf_token %}
                </form> -->
              </div>
              <div class="ahare">
                <button onclick="ahare_create('{% url 'ahare' post.id %}', 'ahare_sum{{ post.id }}')">あはれ</button>
                <span id="ahare_sum{{ post.id }}">
                {% if ahare_sum is None %}0{% endif %}
                {% if not ahare_sum is None %}{{ahare_sum}}{% endif %}
                </span>
                <!-- <form action="{% url 'ahare' post.id %}" method="post">
                  <button type="submit" name='post_id' value={{post.id}}>あはれ</button>
                  <span>
                  {% if ahare_sum is None %}0{% endif %}
                  {% if not ahare_sum is None %}{{ahare_sum}}{% endif %}
                  </span>
                {% csrf_token %}
                </form> -->
              </div>
              <div class="source">
                <div class="author-name">
                  <p>{{ book.author }}</p>
                </div>
                <div class="book-name">
                  <p>{{ book.title }}</p>
                </div>
              </div>
              <td>
                  {{bookmark_flag}}
              </td>
              <td>
                  <form action="{% url 'bookmark'%}" method="post">
                      <button type="submit" name="post_id" value={{post.id}}>しおり</button>
                  {% csrf_token %}
                  </form>
              </td>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- This script was written by Naoki Hirabayashi -->
      <script type="text/javascript">
      const wokashi_create = (url, span_id) => {
        console.log(url);
        console.log(span_id);
        const xhr = new XMLHttpRequest();
        xhr.open("GET", url);
        xhr.responseType = 'json';
        xhr.send();
        xhr.onload = () => {
          const res = xhr.response;
          console.log(res);
          const wokashi_sum = res['wokashi_sum']
          const span = document.getElementById(span_id);
          span.innerHTML = wokashi_sum;
        };
      };

      const ahare_create = (url, span_id) => {
        console.log(url);
        console.log(span_id);
        const xhr = new XMLHttpRequest();
        xhr.open("GET", url);
        xhr.responseType = 'json';
        xhr.send();
        xhr.onload = () => {
          const res = xhr.response;
          console.log(res);
          const ahare_sum = res['ahare_sum'];
          const span = document.getElementById(span_id);
          span.innerHTML = ahare_sum;
        };
      };
      </script>
      <!--  -->

        <input type="checkbox" class="fixed-btn" name="show-popup">
        <div id="popup">
          <!-- Written by Yamamoto Sota -->
          <!-- Updated by Naoki Hirabayashi -->
          <form action="{% url 'create' %}" method="post">
              {% csrf_token %}
              <p class="username">
              <img src="{% static 'posts/img/bookusagi.png' %}" class="icon" alt="icon" align="middle">
                  Username
              </p>
              <textarea name="content" rows="8" cols="100" placeholder="気に入った一文を投稿しよう"></textarea>
              <p>著者名</p>
              <input type="text" name="author">
              <p>書名</p>
              <input type="text" name="title">
              <br><br>
              <input type="submit" name="btn1" value="投稿する">
              <!--  -->
          </form>
        </div>
      </main>
    </div>
  {% endblock contents %}
</body>

</html>
